<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div class="section page-width-content color-{{ section.settings.color_scheme }}">
  <div
    class="
      spacing-style
      layout-panel-flex
      layout-panel-flex--column
      section-content-wrapper
      mobile-column
    "
    style="
      --gap: 24px;
      padding-top: {{ section.settings.padding-block-start }}px;
      padding-bottom: {{ section.settings.padding-block-end }}px;
    "
  >
    <div class="rte" style="max-width: 700px; margin: 0 auto; width: 100%;">
      <!-- Optional: Hide default page title if you want to control it here -->
      <h1 style="text-align: center; margin-bottom: 3rem; text-transform: capitalize; font-weight: 700; letter-spacing: -0.5px;">{{ page.title }}</h1>
      
      {{ page.content }}
      
      <div class="cookie-settings-card">
        <div class="cookie-icon-wrapper">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
            <path d="M8.5 8.5v.01"></path>
            <path d="M16 15.5v.01"></path>
            <path d="M12 12v.01"></path>
            <path d="M11 17v.01"></path>
            <path d="M7 14v.01"></path>
          </svg>
        </div>
        
        <h3>Cookie-Präferenzen verwalten</h3>
        <p>Wir respektieren Ihre Privatsphäre. Hier können Sie festlegen, welche Cookies Sie zulassen möchten. Ihre Einstellungen können jederzeit angepasst werden.</p>
        
        <button id="open-cookie-settings-btn" class="cookie-button">
          <span class="btn-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </span>
          Einstellungen öffnen
        </button>
        
        <div class="security-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
          Sicher & DSGVO-konform
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .cookie-settings-card {
    margin-top: 3rem;
    padding: 3rem;
    background: #ffffff;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.04);
    transition: transform 0.3s ease;
  }
  
  .cookie-settings-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 50px rgba(0,0,0,0.08);
  }

  .cookie-icon-wrapper {
    width: 80px;
    height: 80px;
    background: #f0fdf4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
  }

  .cookie-settings-card h3 {
    margin: 0 0 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a1a;
  }

  .cookie-settings-card p {
    margin: 0 auto 2rem;
    color: #666;
    line-height: 1.6;
    max-width: 450px;
    font-size: 1rem;
  }

  .cookie-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 32px;
    background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
  }

  .cookie-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
    opacity: 0.95;
  }
  
  .cookie-button svg {
    transition: transform 0.5s ease;
  }
  
  .cookie-button:hover svg {
    transform: rotate(90deg);
  }

  .security-note {
    margin-top: 1.5rem;
    font-size: 0.85rem;
    color: #888;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  
  @media (max-width: 768px) {
    .cookie-settings-card {
      padding: 2rem 1.5rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('open-cookie-settings-btn');
    const originalText = btn ? btn.innerHTML : '';

    const openCookieSettings = (e) => {
      e.preventDefault();
      
      if(btn) {
          btn.innerHTML = '<span>Laden...</span>';
          btn.style.opacity = '0.7';
      }

      const resetBtn = () => {
          if(btn) {
              btn.innerHTML = originalText;
              btn.style.opacity = '1';
          }
      };
      
      // Funktion, die prüft, ob die API bereit ist
      const isApiReady = () => {
          return window.Shopify && 
                 window.Shopify.customerPrivacy && 
                 typeof window.Shopify.customerPrivacy.showPreferences === 'function';
      };

      // Polling Funktion: Prüft alle 500ms, ob die API da ist (max 10 Versuche = 5 Sekunden)
      const waitForApi = (attemptsLeft) => {
          if (isApiReady()) {
              console.log('Shopify Customer Privacy API gefunden!');
              window.Shopify.customerPrivacy.showPreferences();
              resetBtn();
              return;
          }

          if (attemptsLeft <= 0) {
              console.warn('Timeout: API wurde nicht geladen.');
              resetBtn();
              alert('Das Cookie-Menü konnte nicht geladen werden. Bitte stellen Sie sicher, dass der Cookie-Banner in den Shopify-Einstellungen aktiviert ist.');
              return;
          }

          console.log('Warte auf Cookie API... Verbleibende Versuche:', attemptsLeft);
          setTimeout(() => waitForApi(attemptsLeft - 1), 500);
      };

      // 1. Sofort versuchen
      if (isApiReady()) {
          window.Shopify.customerPrivacy.showPreferences();
          resetBtn();
          return;
      }
      
      // 2. Andere Apps prüfen (Cookiebot, etc.)
      if (window.Cookiebot && typeof window.Cookiebot.show === 'function') {
          window.Cookiebot.show();
          resetBtn();
          return;
      }
      if (window.Gdpr && typeof window.Gdpr.openPreferences === 'function') {
          window.Gdpr.openPreferences();
          resetBtn();
          return;
      }

      // 3. Wenn nichts da ist, versuchen wir die Shopify API zu laden und warten dann
      console.log('API nicht bereit, starte Ladevorgang...');
      
      if (window.Shopify && window.Shopify.loadFeatures) {
          window.Shopify.loadFeatures(
              [
                  {
                      name: 'consent-tracking-api',
                      version: '0.1',
                  },
              ],
              function (error) {
                  if (error) {
                      console.error('Fehler beim Laden der Features:', error);
                      // Trotzdem versuchen zu warten, falls es parallel lädt
                  }
                  // Starte Polling
                  waitForApi(10);
              }
          );
      } else {
          // Fallback Polling, falls loadFeatures nicht existiert
          waitForApi(10);
      }
    };

    if (btn) {
      btn.addEventListener('click', openCookieSettings);
    }
  });
</script>

{% schema %}
{
  "name": "Cookie Settings",
  "class": "section-wrapper",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 60
    }
  ]
}
{% endschema %}
