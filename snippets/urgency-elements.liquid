<!-- Sales Counter Activity Pill -->
<div class="sales-activity-wrapper">
  <div id="sales-box-{{ product.id }}" class="sales-pill">
    <span class="pulsing-dot"></span>
    <span class="sales-text">
      <strong id="sales-count-{{ product.id }}">--</strong> Verkäufe in den letzten 24 Stunden
    </span>
  </div>
  <div class="sales-subtext">
    Letzter Verkauf: <strong id="last-sale-{{ product.id }}">vor ...</strong> aus <strong id="sale-city-{{ product.id }}">...</strong>
  </div>
</div>

<style>
.sales-activity-wrapper {
  margin: 10px 0 16px;
  display: flex !important;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

.sales-pill {
  display: inline-flex !important;
  align-items: center;
  gap: 10px;
  background-color: #FEE2E2; /* Light red background */
  color: #991B1B; /* Dark red text for contrast */
  padding: 6px 14px;
  border-radius: 100px; /* Pill shape */
  font-size: 13px;
  font-weight: 700;
  border: 1px solid #FECACA;
  line-height: 1.2;
}

/* Pulsing Dot Animation */
.pulsing-dot {
  width: 8px;
  height: 8px;
  background-color: #DC2626; /* Strong red */
  border-radius: 50%;
  position: relative;
  flex-shrink: 0;
}

.pulsing-dot::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 100%; height: 100%;
  border-radius: 50%;
  background-color: #DC2626;
  opacity: 0.6;
  z-index: -1;
  animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
}

@keyframes pulse-ring {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
  100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
}

.sales-text strong {
  font-weight: 800;
  color: #7F1D1D; /* Even darker for the number */
}

.sales-subtext {
  font-size: 11px;
  color: #6B7280; /* Cool grey */
  margin-left: 8px;
}
.sales-subtext strong {
  color: #374151;
  font-weight: 600;
}
</style>

<script>
(function() {
  const pid = {{ product.id }};
  const key = 'sales_' + pid;
  const timeKey = 'sale_time_' + pid;
  const dateKey = 'sales_date_' + pid;
  const startKey = 'sales_start_' + pid;
  const visitKey = 'visit_count_' + pid;
  const lastVisitKey = 'last_visit_' + pid;
  
  // Get today's date
  const today = new Date().toDateString();
  const storedDate = localStorage.getItem(dateKey);
  
  // Reset if new day
  if (storedDate !== today) {
    localStorage.removeItem(key);
    localStorage.removeItem(timeKey);
    localStorage.removeItem(startKey);
    localStorage.removeItem(visitKey);
    localStorage.removeItem(lastVisitKey);
    localStorage.setItem(dateKey, today);
  }
  
  // Track visits and time between visits
  let visitCount = parseInt(localStorage.getItem(visitKey)) || 0;
  const lastVisit = parseInt(localStorage.getItem(lastVisitKey)) || 0;
  const now = Date.now();
  const timeSinceLastVisit = now - lastVisit; // in milliseconds
  
  // Increment visit if more than 2 minutes passed
  if (timeSinceLastVisit > 120000 || visitCount === 0) {
    visitCount++;
    localStorage.setItem(visitKey, visitCount);
    localStorage.setItem(lastVisitKey, now);
  }
  
  // Get rating from page (ddreviews or metafields)
  let rating = 0;
  try {
    rating = {{ product.metafields.ddreviews.content.average_star | default: 0 }};
    if (!rating || rating === 0) {
      const reviewCount = {{ product.metafields.ddreviews.content.total_reviews | default: 0 }};
      if (reviewCount > 0) rating = 4.5;
    }
  } catch(e) {}
  
  // Calculate base sales based on rating
  let baseSales = 20 + (pid % 15); // no rating: 20-35
  
  if (rating >= 4.5) {
    baseSales = 150 + (pid % 100);
  } else if (rating >= 4.0) {
    baseSales = 100 + (pid % 80);
  } else if (rating >= 3.5) {
    baseSales = 70 + (pid % 60);
  } else if (rating > 0) {
    baseSales = 25 + (pid % 15); // low rating: 25-40
  }
  
  // Store initial base if not exists
  let startSales = parseInt(localStorage.getItem(startKey));
  if (!startSales) {
    startSales = baseSales;
    localStorage.setItem(startKey, startSales);
  }
  
  // Calculate gradual growth throughout the day
  const midnight = new Date(now);
  midnight.setHours(0, 0, 0, 0);
  const minutesSinceMidnight = Math.floor((now - midnight) / 60000);
  
  const growthRate = rating >= 4.5 ? 3 : rating >= 4.0 ? 4 : 5;
  const growth = Math.floor(minutesSinceMidnight / growthRate);
  
  // Add progressive increment based on visit count (FOMO effect)
  // Smaller increments for low/no rating products
  let visitBonus = 0;
  if (rating >= 4.5) {
    visitBonus = (visitCount - 1) * 8;
  } else if (rating >= 4.0) {
    visitBonus = (visitCount - 1) * 6;
  } else if (rating >= 3.5) {
    visitBonus = (visitCount - 1) * 4;
  } else if (rating > 0) {
    visitBonus = (visitCount - 1) * 2; // low rating: +2 per visit
  } else {
    visitBonus = (visitCount - 1) * 1; // no rating: +1 per visit
  }
  
  // Calculate current count with strict caps for low/no rating
  let maxSales = 400; // default for high ratings
  if (rating >= 4.5) {
    maxSales = 400;
  } else if (rating >= 4.0) {
    maxSales = 300;
  } else if (rating >= 3.5) {
    maxSales = 200;
  } else if (rating > 0) {
    maxSales = 49; // low rating: max 49
  } else {
    maxSales = 39; // no rating: max 39
  }
  
  let currentCount = Math.min(startSales + growth + visitBonus, maxSales);
  
  // Store and display
  localStorage.setItem(key, currentCount);
  
  const countEl = document.getElementById('sales-count-' + pid);
  const timeEl = document.getElementById('last-sale-' + pid);
  
  if (countEl) countEl.textContent = currentCount;
  
  // Last sale time and city
  const cityEl = document.getElementById('sale-city-' + pid);
  const cityKey = 'sale_city_' + pid;
  
  // Comprehensive German cities list (major and minor)
  const cities = [
    // Major cities
    'Berlin', 'Hamburg', 'München', 'Köln', 'Frankfurt am Main',
    'Stuttgart', 'Düsseldorf', 'Dortmund', 'Essen', 'Leipzig',
    'Bremen', 'Dresden', 'Hannover', 'Nürnberg', 'Duisburg',
    // Large cities
    'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn', 'Münster',
    'Karlsruhe', 'Mannheim', 'Augsburg', 'Wiesbaden', 'Gelsenkirchen',
    'Mönchengladbach', 'Braunschweig', 'Chemnitz', 'Kiel', 'Aachen',
    'Halle', 'Magdeburg', 'Freiburg', 'Krefeld', 'Lübeck',
    'Oberhausen', 'Erfurt', 'Mainz', 'Rostock', 'Kassel',
    // Medium cities
    'Hagen', 'Hamm', 'Saarbrücken', 'Mülheim', 'Potsdam',
    'Ludwigshafen', 'Oldenburg', 'Leverkusen', 'Osnabrück', 'Solingen',
    'Heidelberg', 'Herne', 'Neuss', 'Darmstadt', 'Paderborn',
    'Regensburg', 'Ingolstadt', 'Würzburg', 'Fürth', 'Wolfsburg',
    'Offenbach', 'Ulm', 'Heilbronn', 'Pforzheim', 'Göttingen',
    // Smaller cities
    'Bottrop', 'Trier', 'Recklinghausen', 'Reutlingen', 'Bremerhaven',
    'Koblenz', 'Bergisch Gladbach', 'Jena', 'Remscheid', 'Erlangen',
    'Moers', 'Siegen', 'Hildesheim', 'Salzgitter', 'Cottbus'
  ];
  
  let saleTime = localStorage.getItem(timeKey);
  let saleCity = localStorage.getItem(cityKey);
  
  if (!saleTime || !saleCity) {
    const maxMinutes = rating >= 4.5 ? 10 : rating >= 4.0 ? 20 : 40;
    saleTime = Date.now() - (Math.floor(Math.random() * maxMinutes) + 2) * 60000;
    saleCity = cities[Math.floor(Math.random() * cities.length)];
    localStorage.setItem(timeKey, saleTime);
    localStorage.setItem(cityKey, saleCity);
  }
  
  function updateSaleTime() {
    const diff = Math.floor((Date.now() - parseInt(saleTime)) / 60000);
    if (timeEl) timeEl.textContent = 'vor ' + (diff > 60 ? 60 : diff) + ' Min.';
    if (cityEl) cityEl.textContent = saleCity;
    
    // Change city every 5-10 minutes
    if (diff > 0 && diff % (5 + Math.floor(Math.random() * 6)) === 0) {
      saleCity = cities[Math.floor(Math.random() * cities.length)];
      localStorage.setItem(cityKey, saleCity);
      saleTime = Date.now();
      localStorage.setItem(timeKey, saleTime);
    }
  }
  updateSaleTime();
  setInterval(updateSaleTime, 60000);
})();
</script>

