{% comment %}
  Urgency Elements: Countdown Timer + Sales Counter
{% endcomment %}

<!-- Countdown Timer for Special Price -->
<div id="countdown-timer-{{ product.id }}" class="countdown-timer-box">
  <div class="countdown-icon">⚡</div>
  <div class="countdown-content">
    <span class="countdown-label">Sonderpreis endet in:</span>
    <div class="countdown-digits">
      <span id="countdown-hours-{{ product.id }}">00</span>:<span id="countdown-minutes-{{ product.id }}">00</span>:<span id="countdown-seconds-{{ product.id }}">00</span>
    </div>
  </div>
</div>

<style>
.countdown-timer-box {
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  border: 2px solid #ff9800;
  border-radius: 10px;
  padding: 12px 16px;
  margin: 12px 0;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
  animation: pulse-border 2s ease-in-out infinite;
}

@keyframes pulse-border {
  0%, 100% { border-color: #ff9800; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2); }
  50% { border-color: #f57c00; box-shadow: 0 6px 18px rgba(255, 152, 0, 0.35); }
}

.countdown-icon {
  font-size: 28px;
  line-height: 1;
  animation: flash 1.5s ease-in-out infinite;
}

@keyframes flash {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}

.countdown-content {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.countdown-label {
  font-size: 15px;
  font-weight: 600;
  color: #e65100;
}

.countdown-digits {
  font-size: 20px;
  font-weight: 800;
  color: #bf360c;
  font-family: 'Courier New', monospace;
  letter-spacing: 1px;
}

.countdown-digits span {
  display: inline-block;
  min-width: 24px;
  text-align: center;
}

@media (max-width: 768px) {
  .countdown-timer-box {
    padding: 10px 14px;
  }
  
  .countdown-icon {
    font-size: 24px;
  }
  
  .countdown-label {
    font-size: 13px;
  }
  
  .countdown-digits {
    font-size: 18px;
  }
}
</style>

<!-- Sales Counter -->
<div id="sales-box-{{ product.id }}" class="sales-compact">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff5722" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
    <polyline points="17 6 23 6 23 12"></polyline>
  </svg>
  <span class="sales-text">
    <strong id="sales-count-{{ product.id }}">--</strong> Verkäufe in den letzten 24 Stunden
    <span class="sales-time">• Letzter Verkauf: <strong id="last-sale-{{ product.id }}">vor ...</strong></span>
  </span>
</div>

<style>
.sales-compact {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  font-size: 14px;
  color: #d84315;
  margin: 8px 0;
}
.sales-compact svg { flex-shrink: 0; }
.sales-text { display: flex; flex-wrap: wrap; gap: 6px; align-items: baseline; }
.sales-text strong { font-weight: 700; }
.sales-time { font-size: 13px; color: #666; }
</style>

<script>
// Countdown Timer Logic
(function() {
  const pid = {{ product.id }};
  const timerKey = 'countdown_end_' + pid;
  const hoursEl = document.getElementById('countdown-hours-' + pid);
  const minutesEl = document.getElementById('countdown-minutes-' + pid);
  const secondsEl = document.getElementById('countdown-seconds-' + pid);
  
  if (!hoursEl || !minutesEl || !secondsEl) return;
  
  function pad(num) {
    return String(num).padStart(2, '0');
  }
  
  function getEndTime() {
    let endTime = localStorage.getItem(timerKey);
    if (!endTime) {
      // Set random duration between 3-6 hours
      const hours = 3 + Math.floor(Math.random() * 4);
      endTime = Date.now() + (hours * 60 * 60 * 1000);
      localStorage.setItem(timerKey, endTime);
    }
    return parseInt(endTime);
  }
  
  function updateCountdown() {
    const now = Date.now();
    let endTime = getEndTime();
    let remaining = endTime - now;
    
    // If expired, reset with new random duration
    if (remaining <= 0) {
      localStorage.removeItem(timerKey);
      endTime = getEndTime();
      remaining = endTime - now;
    }
    
    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
    
    hoursEl.textContent = pad(hours);
    minutesEl.textContent = pad(minutes);
    secondsEl.textContent = pad(seconds);
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
})();
</script>

<script>
(function() {
  const pid = {{ product.id }};
  const key = 'sales_' + pid;
  const timeKey = 'sale_time_' + pid;
  const dateKey = 'sales_date_' + pid;
  const startKey = 'sales_start_' + pid;
  const visitKey = 'visit_count_' + pid;
  const lastVisitKey = 'last_visit_' + pid;
  
  // Get today's date
  const today = new Date().toDateString();
  const storedDate = localStorage.getItem(dateKey);
  
  // Reset if new day
  if (storedDate !== today) {
    localStorage.removeItem(key);
    localStorage.removeItem(timeKey);
    localStorage.removeItem(startKey);
    localStorage.removeItem(visitKey);
    localStorage.removeItem(lastVisitKey);
    localStorage.setItem(dateKey, today);
  }
  
  // Track visits and time between visits
  let visitCount = parseInt(localStorage.getItem(visitKey)) || 0;
  const lastVisit = parseInt(localStorage.getItem(lastVisitKey)) || 0;
  const now = Date.now();
  const timeSinceLastVisit = now - lastVisit; // in milliseconds
  
  // Increment visit if more than 2 minutes passed
  if (timeSinceLastVisit > 120000 || visitCount === 0) {
    visitCount++;
    localStorage.setItem(visitKey, visitCount);
    localStorage.setItem(lastVisitKey, now);
  }
  
  // Get rating from page (ddreviews or metafields)
  let rating = 0;
  try {
    rating = {{ product.metafields.ddreviews.content.average_star | default: 0 }};
    if (!rating || rating === 0) {
      const reviewCount = {{ product.metafields.ddreviews.content.total_reviews | default: 0 }};
      if (reviewCount > 0) rating = 4.5;
    }
  } catch(e) {}
  
  // Calculate base sales based on rating
  let baseSales = 20 + (pid % 15); // no rating: 20-35
  
  if (rating >= 4.5) {
    baseSales = 150 + (pid % 100);
  } else if (rating >= 4.0) {
    baseSales = 100 + (pid % 80);
  } else if (rating >= 3.5) {
    baseSales = 70 + (pid % 60);
  } else if (rating > 0) {
    baseSales = 25 + (pid % 15); // low rating: 25-40
  }
  
  // Store initial base if not exists
  let startSales = parseInt(localStorage.getItem(startKey));
  if (!startSales) {
    startSales = baseSales;
    localStorage.setItem(startKey, startSales);
  }
  
  // Calculate gradual growth throughout the day
  const midnight = new Date(now);
  midnight.setHours(0, 0, 0, 0);
  const minutesSinceMidnight = Math.floor((now - midnight) / 60000);
  
  const growthRate = rating >= 4.5 ? 3 : rating >= 4.0 ? 4 : 5;
  const growth = Math.floor(minutesSinceMidnight / growthRate);
  
  // Add progressive increment based on visit count (FOMO effect)
  // Smaller increments for low/no rating products
  let visitBonus = 0;
  if (rating >= 4.5) {
    visitBonus = (visitCount - 1) * 8;
  } else if (rating >= 4.0) {
    visitBonus = (visitCount - 1) * 6;
  } else if (rating >= 3.5) {
    visitBonus = (visitCount - 1) * 4;
  } else if (rating > 0) {
    visitBonus = (visitCount - 1) * 2; // low rating: +2 per visit
  } else {
    visitBonus = (visitCount - 1) * 1; // no rating: +1 per visit
  }
  
  // Calculate current count with strict caps for low/no rating
  let maxSales = 400; // default for high ratings
  if (rating >= 4.5) {
    maxSales = 400;
  } else if (rating >= 4.0) {
    maxSales = 300;
  } else if (rating >= 3.5) {
    maxSales = 200;
  } else if (rating > 0) {
    maxSales = 49; // low rating: max 49
  } else {
    maxSales = 39; // no rating: max 39
  }
  
  let currentCount = Math.min(startSales + growth + visitBonus, maxSales);
  
  // Store and display
  localStorage.setItem(key, currentCount);
  
  const countEl = document.getElementById('sales-count-' + pid);
  const timeEl = document.getElementById('last-sale-' + pid);
  
  if (countEl) countEl.textContent = currentCount;
  
  // Last sale time (more recent for popular products)
  let saleTime = localStorage.getItem(timeKey);
  if (!saleTime) {
    const maxMinutes = rating >= 4.5 ? 10 : rating >= 4.0 ? 20 : 40;
    saleTime = Date.now() - (Math.floor(Math.random() * maxMinutes) + 2) * 60000;
    localStorage.setItem(timeKey, saleTime);
  }
  
  function updateSaleTime() {
    const diff = Math.floor((Date.now() - parseInt(saleTime)) / 60000);
    if (timeEl) timeEl.textContent = 'vor ' + (diff > 60 ? 60 : diff) + ' Min.';
  }
  updateSaleTime();
  setInterval(updateSaleTime, 60000);
})();
</script>
