{% comment %}
  Renders an optimized image with WebP support and proper srcset
  
  Accepts:
  - image: {Object} Image object
  - width: {Number} Maximum width
  - height: {Number} Maximum height (optional)
  - class: {String} CSS classes
  - alt: {String} Alt text
  - loading: {String} 'lazy' or 'eager'
  - fetchpriority: {String} 'high', 'low', or 'auto'
  - sizes: {String} Sizes attribute
  
  Usage:
  {% render 'optimized-image',
    image: product.featured_image,
    width: 800,
    class: 'product-image',
    alt: product.title,
    loading: 'lazy'
  %}
{% endcomment %}

{% liquid
  assign image_width = width | default: 1000
  assign image_class = class | default: ''
  assign image_alt = alt | default: image.alt | default: ''
  assign image_loading = loading | default: 'lazy'
  assign image_fetchpriority = fetchpriority | default: 'auto'
  
  # Define responsive widths
  assign widths = '200,300,400,500,600,800,1000,1200,1600'
  
  # Default sizes if not provided
  unless sizes
    assign sizes = '(max-width: 749px) 100vw, (max-width: 999px) 50vw, 33vw'
  endunless
%}

{% if image %}
  <picture>
    {%- # WebP sources for modern browsers -%}
    <source
      type="image/webp"
      srcset="
        {%- for width in widths | split: ',' -%}
          {{ image | image_url: width: width, format: 'pjpg' }} {{ width }}w
          {%- unless forloop.last -%}, {%- endunless -%}
        {%- endfor -%}
      "
      sizes="{{ sizes }}"
    >
    
    {%- # Fallback JPEG for older browsers -%}
    <source
      type="image/jpeg"
      srcset="
        {%- for width in widths | split: ',' -%}
          {{ image | image_url: width: width }} {{ width }}w
          {%- unless forloop.last -%}, {%- endunless -%}
        {%- endfor -%}
      "
      sizes="{{ sizes }}"
    >
    
    {%- # Fallback img tag -%}
    <img
      src="{{ image | image_url: width: image_width }}"
      alt="{{ image_alt }}"
      class="{{ image_class }}"
      loading="{{ image_loading }}"
      {% if image_fetchpriority != 'auto' %}fetchpriority="{{ image_fetchpriority }}"{% endif %}
      {% if height %}height="{{ height }}"{% endif %}
      width="{{ image_width }}"
      decoding="async"
    >
  </picture>
{% endif %}
